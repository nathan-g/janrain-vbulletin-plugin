<?xml version="1.0" encoding="ISO-8859-1"?>

<product productid="janrain_engage" active="1">
	<title>Janrain Engage</title>
	<description>Janrain Engage</description>
	<version>0.1</version>
	<url>http://www.janrain.com</url>
	<versioncheckurl />
	<dependencies>
		<dependency dependencytype="php" minversion="5" maxversion="" />
		<dependency dependencytype="vbulletin" minversion="4.1.2" maxversion="" />
	</dependencies>
	<codes>
	</codes>
	<templates>
	</templates>
	<stylevardfns>
	</stylevardfns>
	<stylevars>
	</stylevars>
	<plugins>
		<plugin active="1" executionorder="5">
			<title>Janrain Engage Register Form Footer</title>
			<hookname>register_form_start</hookname>
			<phpcode><![CDATA[$footer .= '
<script type="text/javascript">
  var rpxJsHost = (("https:" == document.location.protocol) ? "https://" : "http://static.");
  document.write(unescape("%3Cscript src=\'" + rpxJsHost +
"rpxnow.com/js/lib/rpx.js\' type=\'text/javascript\'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  RPXNOW.overlay = true;
  RPXNOW.language_preference = \'en\';
</script>
';]]></phpcode>
		</plugin>
		<plugin active="1" executionorder="1">
			<title>Janrain Engage Register Sign In</title>
			<hookname>register_start</hookname>
			<phpcode><![CDATA[$je_output = '';
if (isset($_POST['token'])) {
  $je_token = $_POST['token'];
  if (strlen($je_token) == 40) {
    require_once(DIR . '/packages/janrain_engage/engage.lib.php');
    $je_api_key = 'YOUR API KEY';
    $je_token = $_POST['token'];
    $je_format = ENGAGE_FORMAT_JSON;
    $je_extended = false;
    $je_result = engage_auth_info($je_api_key, $je_token, $je_format, $je_extended);
    if ($je_result === false) {
      $je_errors = engage_get_errors();
      foreach ($je_errors as $error=>$label) {
        $je_output .= '<br />Error: '.$error;
      }
    } else {
      $je_array_out = true;
      $je_auth_info_array = engage_parse_result($je_result, $je_format, $je_array_out);
      $je_profile = $je_auth_info_array['profile'];
      if (!empty($je_profile['name']['formatted'])) {
        $username = str_replace(' ', '_', $je_profile['name']['formatted']);
      }
      if (!empty($je_profile['givenName']) && !empty($je_profile['familyName'])) {
        $username = $je_profile['givenName'].'_'.$je_profile['familyName'];
      }
      if (!empty($je_profile['preferredUsername'])) {
        $username = $je_profile['preferredUsername'];
      }
      if (!empty($je_profile['email'])) {
        $email = $je_profile['email'];
      }
      if (!empty($je_profile['verifiedEmail'])) {
        $email = $je_profile['verifiedEmail'];
        $emailconfirm = $je_profile['verifiedEmail'];
      }
      if (!empty($je_profile['identifier'])) {
        $referrername = $je_profile['identifier'];
      }
    }
  }
}
$janrain_engage_enabled = true;
$janrain_engage_title = 'Janrain Engage';
$janrain_engage_form = '';
$janrain_engage_signin = '
$janrain_enagage_realm = 'YOUR FULL REALM DOMAIN';//<===MANUAL CONFIG
$janrain_engage_reg_path = urlencode('URL TO register.php');//<===MANUAL CONFIG
<a class="rpxnow" onclick="return false;" href="https://'.$janrain_engage_realm.'/openid/v2/signin?token_url='.$janrain_engage_reg_path.'"> Register with Engage </a>
';

vB_Template::preRegister('register', array(
'janrain_engage_enabled' => $janrain_engage_enabled,
'janrain_engage_title' => $janrain_engage_title,
'janrain_engage_form' => $janrain_engage_form.$je_output,
'janrain_engage_signin' => $janrain_engage_signin
));]]></phpcode>
		</plugin>
	</plugins>
	<phrases>
	</phrases>
	<options>
	</options>
	<helptopics>
	</helptopics>
	<cronentries>
	</cronentries>
	<faqentries>
	</faqentries>
</product>
